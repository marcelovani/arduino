<!--https://canvasjs.com/docs/charts/how-to/create-charts-from-csv/-->
<!DOCTYPE html>
<html>
<head>
<title>Velocity detector</title>
<style>
output {
    display: block;
    margin-top: 4em;
    font-family: monospace;
    font-size: .8em;
}
</style>
<script type="text/javascript" src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

<script type="text/javascript">
//<![CDATA[
    window.onload = function() {      
		var fileInput = document.getElementById("csv"),

		    readFile = function () {
		        var reader = new FileReader();
		        reader.onload = function () {
		            //document.getElementById('out').innerHTML = reader.result;
		            var dataPoints = getDataPointsFromCSV(reader.result);

					// Clean clones.
					for (var i = 1; i < 100; i++) {
						id = 'chartContainer-' + i;
						var div = document.getElementById(id);
						if (div !== null) {
							document.getElementById(id).remove();
						}
					}

					// Display acceleration chart
					divId = cloneDiv('chartContainer', 1);
		           	var chart = new CanvasJS.Chart(divId, {
					    title: {
					         text: "Acceleration",
					    },
					    data: [{
					         type: "line",
					         dataPoints: dataPoints
					      }]
				    });
				    chart.render();

				    // Display velocity chart
					var velocityPoints = calcVelocity(dataPoints);
					divId = cloneDiv('chartContainer', 2);
		           	var chart = new CanvasJS.Chart(divId, {
					    title: {
					         text: "Velocity",
					    },
					    data: [{
					         type: "line",
					         dataPoints: velocityPoints
					      }]
				    });
				    chart.render();
		        };
		        reader.readAsBinaryString(fileInput.files[0]);
		    };

		fileInput.addEventListener('change', readFile);

    }

    function cloneDiv(id, i) {
		var div = document.getElementById(id),
	    clone = div.cloneNode(true);
		clone.id = id + '-' + i;
		clone.style.display = "block";
		document.body.appendChild(clone);

		return clone.id;
    }

    function getDataPointsFromCSV(csv) {
    	var time, prevTime, accTime = 0;
    	var acceleration = 0;
        var dataPoints = csvLines = points = [];
        csvLines = csv.split(/[\r?\n|\r|\n]+/);         
	        
        for (var i = 0; i < csvLines.length; i++) {
            if (csvLines[i].length > 0) {
                points = csvLines[i].split(",");
                for (var p = 1; p < points.length; p++) {
                	// Initialize object.
                	if (typeof dataPoints[p] == "undefined") {
                		dataPoints[p] = [];
                	}

                	// First line contains headers
                	time = points[0];
                	acceleration = points[p];

                	// Other lines contain the float values
                	if (i > 0) {
                		// Convert dates to timestamp i.e. '2019/09/22 10:14:06.753'
                		var myDate = new Date(time);
						var timestamp = myDate.getTime();
						if (timestamp) {
							ss = myDate.getSeconds();
							ms = myDate.getMilliseconds();
							time = ss.toString().padStart(2, '0') + '.' + ms.toString().padStart(3, '0');
						}

                		time = parseFloat(time);
                		acceleration = parseFloat(acceleration*-1); // Invert Y data from iphone app
                	}

					accTime = accTime + time - prevTime;

	                dataPoints[p].push({ 
	                    x: time,
	                    y: acceleration
	                });

	                prevTime = time;
    			}
            }
        }

        // Keep only Y data
        if (dataPoints.length > 2) {
        	dataPoints = dataPoints[2];
        }
        else {
        	dataPoints = dataPoints[1];
        }

        // Normalize time
        var offsetTime = -1;
        for (var i = 1; i < dataPoints.length; i++) {
        	var currTime = dataPoints[i].x;
        	if (offsetTime < 0) {
        		offsetTime = currTime;
        	}
        	dataPoints[i].x = currTime - offsetTime;
        }

        return dataPoints;
    }

    function calcVelocity(data) {
    	var velocityPoints = [];
    	var velocity = 0;
		for (i = 2; i < data.length -1; i++)
		{
			var prevAcc = data[i-1].y;
			var curAcc = data[i].y;
			var time = data[i].x;
			var prevTime = data[i-1].x;
			velocity += (prevAcc + curAcc) / 2 * (time - prevTime) / 1000;
        	velocityPoints.push({ 
                x: time,
                y: velocity
            });
		}

        return velocityPoints;
    }

  //]]>
</script>

<script type="text/javascript">
    var url = "data.csv";

    plot = function() {
	 

	
	$.get(url, function(data) {


	});
  }
</script>

</head>
<body>
	<p>Select local CSV File:</p>
	<input id="csv" type="file">
	<output id="out"></output>

	<div id="chartContainer" class"main" style="display:none; height: 370px; max-width: 920px; margin: 0px auto;"></div>
</body>
</html>