<!--https://canvasjs.com/docs/charts/how-to/create-charts-from-csv/-->
<!DOCTYPE html>
<html>
<head>
<title>Velocity detector</title>
<style>
output {
    display: block;
    margin-top: 4em;
    font-family: monospace;
    font-size: .8em;
}
</style>
<script type="text/javascript" src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

<script type="text/javascript">
//<![CDATA[

    // Main
    window.onload = function() {      
		var fileInput = document.getElementById("csv"),
		    readFile = function () {
		        var reader = new FileReader();
		        reader.onload = function () {
		            var dataPoints = getDataPointsFromCSV(reader.result);
					clearCharts();
					showAccelerationChart(dataPoints);
					showVelocityChart(dataPoints);
					detectChange(dataPoints);
		        };
		        reader.readAsBinaryString(fileInput.files[0]);
		    };

		fileInput.addEventListener('change', readFile);

    }

	// Creates clones of elements
    function cloneElement(id, i) {
		var div = document.getElementById(id),
	    clone = div.cloneNode(true);
		clone.id = id + '-' + i;
		clone.style.display = "block";
		document.body.appendChild(clone);

		return clone.id;
    }

	// Clean charts
    function clearCharts() {	
		for (var i = 1; i < 100; i++) {
			id = 'chartContainer-' + i;
			var div = document.getElementById(id);
			if (div !== null) {
				document.getElementById(id).remove();
			}
		}
    }

	// Display acceleration chart
    function showAccelerationChart(dataPoints) {
		divId = cloneElement('chartContainer', 1);
       	var chart = new CanvasJS.Chart(divId, {
		    title: {
		         text: "Acceleration",
		    },
		    data: [{
		         type: "line",
		         dataPoints: dataPoints
		      }]
	    });
	    chart.render();
    }

	// Display velocity chart
    function showVelocityChart(dataPoints) {
		var velocityPoints = calcVelocity(dataPoints);
		divId = cloneElement('chartContainer', 2);
       	var chart = new CanvasJS.Chart(divId, {
		    title: {
		         text: "Velocity",
		    },
		    data: [{
		         type: "line",
		         dataPoints: velocityPoints
		      }]
	    });
	    chart.render();
    }

    // Read csv and populate data
    function getDataPointsFromCSV(csv) {
    	var time = prevTime = accTime = 0;
    	var offsetTime = -1;
    	var acceleration = 0;
        var dataPoints = csvLines = points = [];
        csvLines = csv.split(/[\r?\n|\r|\n]+/);         
	        
        for (var i = 0; i < csvLines.length; i++) {
            if (csvLines[i].length > 0) {
                points = csvLines[i].split(",");

                switch (points.length) {
                	case 2:
                		time = points[0];
	                	acceleration = points[1];
                		break

                	case 4:
	                	time = points[0];
	                	// Extract only y form CSV with xyz
	                	acceleration = points[2];
                		break;
                }

        		// Convert dates to timestamp i.e. '2019/09/22 10:14:06.753'
        		var myDate = new Date(time);
				var timestamp = myDate.getTime();
				if (timestamp) {
					ss = myDate.getSeconds();
					ms = myDate.getMilliseconds();
					time = ss.toString().padStart(2, '0') + '.' + ms.toString().padStart(3, '0');
				}

        		time = parseFloat(time);
        		if (time >= 0) {
            		acceleration = parseFloat(acceleration*-1); // Invert Y data from iphone app

            		// Normalize time to make it start from 0
		        	if (offsetTime < 0) {
		        		offsetTime = time;
		        	}

	                dataPoints.push({ 
	                    x: time - offsetTime,
	                    y: acceleration
	                });
	            }

            }
        }

        return dataPoints;
    }

    // Calculate velocity
    function calcVelocity(data) {
    	var velocityPoints = [];
    	var velocity = 0;
		for (i = 2; i < data.length -1; i++)
		{
			var prevAcc = data[i-1].y;
			var curAcc = data[i].y;
			var time = data[i].x;
			var prevTime = data[i-1].x;
			velocity += (prevAcc + curAcc) / 2 * (time - prevTime);
        	velocityPoints.push({ 
                x: time,
                y: velocity
            });
		}

        return velocityPoints;
    }

    // Detect a drop after it reached the peak
    function detectChange(data) {
    	var prevAcc = 0;
    	var prevTime = 0;
    	var velocity = 0;
		for (i = 0; i < data.length; i++)
		{
			var curAcc = data[i].y; // Read Acc X
			var time = data[i].x; // millis()
			velocity += (prevAcc + curAcc) / 2 * (time - prevTime);

			prevTime = time;
			prevAcc = curAcc;
		}
    }

  //]]>
</script>

</head>
<body>
	<p>Select local CSV File:</p>
	<input id="csv" type="file">
	<output id="out"></output>

	<div id="chartContainer" class"main" style="display:none; height: 370px; max-width: 920px; margin: 0px auto;"></div>
</body>
</html>